branches:
    only:
        - "master"

language: python

# Build against pydicom master and current release
matrix:
    include:
        # OSX first because it takes a long time to complete before_install
        - name: "Python 3.6, OSX + pydicom release"
          os: osx
          language: generic
          env: TEST_SUITE=osx
          env: PYTHON=3.6.8
        # Ubuntu with pydicom master next to find any issues quickly
        - name: "Python 3.6, Ubuntu + pydicom master"
          os: linux
          dist: bionic
          python: "3.6"
          env: TEST_SUITE=pydicom_master
        - name: "Python 3.7, Ubuntu + pydicom master"
          os: linux
          dist: bionic
          python: "3.7"
          env: TEST_SUITE=pydicom_master
        - name: "Python 3.8, Ubuntu + pydicom master"
          os: linux
          dist: bionic
          python: "3.8"
          env: TEST_SUITE=pydicom_master
        - name: "Python 3.6, Ubuntu"
          os: linux
          dist: bionic
          python: "3.6"
          env: TEST_SUITE=solo
        - name: "Python 3.7, Ubuntu"
          os: linux
          dist: bionic
          python: "3.7"
          env: TEST_SUITE=solo
        - name: "Python 3.8, Ubuntu"
          os: linux
          dist: bionic
          python: "3.8"
          env: TEST_SUITE=solo
        - name: "Python 3.6, Ubuntu + pydicom release"
          os: linux
          dist: bionic
          python: "3.6"
          env: TEST_SUITE=pydicom_release
        - name: "Python 3.7, Ubuntu + pydicom release"
          os: linux
          dist: bionic
          python: "3.7"
          env: TEST_SUITE=pydicom_release
        - name: "Python 3.8, Ubuntu + pydicom release"
          os: linux
          dist: bionic
          python: "3.8"
          env: TEST_SUITE=pydicom_release

before_install: |
  if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    brew update
    brew install openssl readline
    brew outdated pyenv || brew upgrade pyenv
    brew install pyenv-virtualenv
    pyenv install $PYTHON
    export PYENV_VERSION=$PYTHON
    export PATH="/Users/travis/.pyenv/shims:${PATH}"
    pyenv-virtualenv venv
    source venv/bin/activate
    python --version
    pip install --upgrade pip
  fi


# Install dependencies and package
install:
    - source build_tools/travis/install.sh
    - python -m pip install . -v

# Command to run tests
script:
    - pytest --cov pylibjpeg

after_success:
    # Upload coverage results to codecov.io
    # curl times out sometimes, so drop the connection timeout but retry more often
    - bash <(curl --connect-timeout 10 --retry 10 --retry-max-time 0 https://codecov.io/bash) ||
      (sleep 30 && bash <(curl --connect-timeout 10 --retry 10 --retry-max-time 0 https://codecov.io/bash))

notifications:
    email: false
